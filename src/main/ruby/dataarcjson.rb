#!/bin/ruby
# {"source":"SEAD","Identifier":"SITE000052","Start":400,"End":1550,"Phase":null,"placename":"Bessastadir","regional catchment area":null,"function of site":null,"type of site":null,"Title":null,"Oldest extant manuscript shelf number":null,"Oldest extant manuscript date":null,"country":"Iceland","Lat":64.1,"Lon":-22,"size":null,"Who":null,"What":null,"theme":null,"tags":null,"# of Resources":null,"Link":"http://qsead.sead.se/applications/sead/show_site_details.php?site_id=440","Description":"Period: Medieval; # of Samples: 54 ; # of Species: 105 ; Observations: 696 ; Abundance: 2419","Data":"{SITE000052: [[SAMP000108,2.15,2.15,2.15,12.90,1.08,16.13,4.30,8.60,0.00,0.00,1.08,0.00,10.75,5.38,2.15,4.30,2.15,1.08,11.83,11.83],[SAMP000109,2.91,1.94,0.97,11.65,2.91,14.56,4.85,8.74,0.00,0.00,0.97,0.00,10.68,5.83,1.94,2.91,1.94,0.97,12.62,13.59],[SAMP000110,2.33,3.49,0.00,13.95,1.16,13.95,2.33,11.63,0.00,0.00,0.00,0.00,9.30,3.49,0.00,4.65,1.16,1.16,16.28,15.12],[SAMP000111,2.86,4.29,1.43,11.43,4.29,17.14,2.86,8.57,0.00,0.00,0.00,0.00,10.00,5.71,1.43,4.29,1.43,2.86,11.43,10.00],[SAMP000112,3.08,3.08,0.00,10.77,0.00,13.85,3.08,12.31,0.00,0.00,1.54,0.00,13.85,6.15,1.54,4.62,3.08,0.00,13.85,9.23],[SAMP000113,1.75,5.26,0.00,14.04,0.00,17.54,5.26,10.53,0.00,0.00,1.75,0.00,8.77,5.26,1.75,7.02,0.00,1.75,10.53,8.77],[SAMP000114,0.00,2.63,2.63,10.53,2.63,18.42,2.63,10.53,0.00,0.00,2.63,0.00,13.16,10.53,5.26,5.26,2.63,0.00,5.26,5.26],[SAMP000115,3.33,3.33,0.00,10.00,0.00,10.00,0.00,20.00,0.00,0.00,0.00,0.00,13.33,3.33,0.00,3.33,3.33,0.00,20.00,10.00],[SAMP006229,0.00,6.38,2.13,6.38,0.00,14.89,4.26,10.64,0.00,0.00,2.13,0.00,14.89,6.38,2.13,4.26,4.26,0.00,8.51,12.77],[SAMP006230,0.00,3.45,6.90,17.24,0.00,13.79,6.90,6.90,0.00,0.00,0.00,0.00,6.90,3.45,10.34,3.45,3.45,0.00,10.34,6.90],[SAMP006231,0.00,9.09,0.00,9.09,0.00,9.09,0.00,18.18,0.00,0.00,0.00,0.00,27.27,0.00,0.00,0.00,0.00,0.00,9.09,18.18],[SAMP006232,0.00,7.69,0.00,7.69,0.00,7.69,0.00,23.08,0.00,0.00,0.00,0.00,30.77,0.00,0.00,0.00,0.00,0.00,7.69,15.38],[SAMP006233,0.00,8.33,4.17,8.33,0.00,20.83,8.33,4.17,0.00,0.00,0.00,0.00,12.50,4.17,4.17,4.17,4.17,0.00,8.33,8.33],[SAMP006234,2.27,9.09,2.27,6.82,0.00,18.18,4.55,9.09,0.00,0.00,0.00,0.00,13.64,6.82,2.27,4.55,4.55,0.00,6.82,9.09],[SAMP006235,0.00,8.57,5.71,11.43,0.00,14.29,5.71,5.71,0.00,0.00,0.00,0.00,8.57,2.86,5.71,5.71,5.71,0.00,11.43,8.57],[SAMP006236,0.00,5.26,5.26,10.53,0.00,15.79,5.26,5.26,0.00,0.00,0.00,0.00,10.53,10.53,5.26,5.26,5.26,0.00,5.26,10.53],[SAMP006237,0.00,9.52,7.14,11.90,0.00,14.29,2.38,4.76,0.00,0.00,0.00,0.00,14.29,2.38,4.76,4.76,4.76,0.00,9.52,9.52],[SAMP006238,1.47,4.41,4.41,7.35,0.00,14.71,5.88,10.29,0.00,0.00,0.00,0.00,13.24,4.41,2.94,2.94,2.94,1.47,10.29,13.24],[SAMP006239,2.17,2.17,2.17,8.70,0.00,13.04,4.35,13.04,0.00,0.00,2.17,0.00,13.04,4.35,2.17,2.17,0.00,0.00,17.39,13.04],[SAMP006240,2.00,4.00,2.00,16.00,0.00,16.00,2.00,10.00,0.00,0.00,2.00,0.00,14.00,4.00,2.00,4.00,2.00,0.00,8.00,12.00],[SAMP006241,0.00,4.35,1.45,10.14,0.00,18.84,2.90,10.14,0.00,0.00,0.00,0.00,15.94,8.70,1.45,2.90,2.90,0.00,11.59,8.70],[SAMP006242,0.00,7.32,2.44,12.20,0.00,14.63,2.44,14.63,0.00,0.00,0.00,0.00,14.63,2.44,2.44,2.44,4.88,0.00,7.32,12.20],[SAMP006243,2.08,4.17,4.17,6.25,0.00,14.58,4.17,10.42,0.00,0.00,0.00,0.00,16.67,8.33,4.17,2.08,2.08,0.00,12.50,8.33],[SAMP006244,1.72,3.45,3.45,8.62,0.00,15.52,5.17,8.62,0.00,0.00,1.72,0.00,12.07,6.90,5.17,3.45,1.72,0.00,12.07,10.34],[SAMP006245,0.00,14.29,0.00,28.57,0.00,28.57,0.00,0.00,0.00,0.00,0.00,0.00,14.29,0.00,0.00,0.00,0.00,0.00,0.00,14.29],[SAMP006246,1.64,4.92,3.28,8.20,0.00,16.39,3.28,11.48,0.00,0.00,0.00,0.00,14.75,6.56,3.28,1.64,3.28,0.00,8.20,13.11],[SAMP006247,0.00,8.70,4.35,13.04,0.00,17.39,4.35,0.00,0.00,0.00,0.00,0.00,8.70,4.35,4.35,4.35,4.35,0.00,13.04,13.04],[SAMP006248,0.00,1.92,3.85,9.62,0.00,17.31,3.85,9.62,0.00,0.00,0.00,0.00,9.62,9.62,3.85,3.85,3.85,0.00,7.69,15.38],[SAMP006249,0.00,0.00,0.00,30.00,0.00,20.00,10.00,20.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,10.00,10.00],[SAMP006250,4.84,3.23,3.23,8.06,0.00,14.52,6.45,8.06,0.00,0.00,0.00,0.00,16.13,4.84,4.84,1.61,1.61,1.61,12.90,8.06],[SAMP006251,0.00,7.69,0.00,15.38,0.00,15.38,7.69,15.38,0.00,0.00,0.00,0.00,23.08,0.00,7.69,0.00,0.00,0.00,0.00,7.69],[SAMP006252,0.00,0.00,0.00,0.00,0.00,0.00,0.00,40.00,0.00,0.00,0.00,0.00,40.00,0.00,0.00,0.00,0.00,0.00,20.00,0.00],[SAMP006253,1.45,2.90,2.90,7.25,1.45,14.49,5.80,10.14,0.00,0.00,1.45,0.00,14.49,8.70,5.80,2.90,2.90,0.00,8.70,8.70],[SAMP006254,0.00,0.00,16.67,0.00,0.00,0.00,0.00,33.33,0.00,0.00,0.00,0.00,33.33,0.00,16.67,0.00,0.00,0.00,0.00,0.00],[SAMP006255,0.00,0.00,16.67,0.00,0.00,0.00,0.00,33.33,0.00,0.00,0.00,0.00,33.33,0.00,16.67,0.00,0.00,0.00,0.00,0.00],[SAMP006256,0.00,0.00,0.00,0.00,100.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006257,0.00,4.35,4.35,4.35,4.35,8.70,8.70,17.39,0.00,0.00,0.00,0.00,17.39,4.35,4.35,0.00,4.35,0.00,4.35,13.04],[SAMP006258,0.00,0.00,0.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006259,0.00,0.00,0.00,0.00,14.29,0.00,0.00,42.86,0.00,0.00,0.00,0.00,28.57,0.00,0.00,0.00,0.00,0.00,0.00,14.29],[SAMP006260,0.00,0.00,14.29,0.00,14.29,0.00,0.00,28.57,0.00,0.00,0.00,0.00,28.57,0.00,14.29,0.00,0.00,0.00,0.00,0.00],[SAMP006261,0.00,0.00,0.00,14.29,14.29,14.29,0.00,14.29,0.00,0.00,14.29,0.00,0.00,0.00,0.00,14.29,0.00,0.00,0.00,14.29],[SAMP006262,0.00,0.00,0.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006263,0.00,0.00,0.00,0.00,33.33,0.00,0.00,33.33,0.00,0.00,0.00,0.00,33.33,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006264,0.00,0.00,0.00,0.00,20.00,0.00,0.00,40.00,0.00,0.00,0.00,0.00,40.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006265,6.67,0.00,0.00,6.67,6.67,13.33,6.67,20.00,0.00,0.00,0.00,0.00,20.00,6.67,0.00,0.00,0.00,0.00,6.67,6.67],[SAMP006266,12.50,0.00,0.00,0.00,12.50,0.00,12.50,12.50,0.00,0.00,12.50,0.00,12.50,0.00,12.50,12.50,0.00,0.00,0.00,0.00],[SAMP006267,0.00,0.00,0.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006268,0.00,0.00,10.00,0.00,10.00,0.00,0.00,20.00,0.00,0.00,10.00,0.00,20.00,0.00,10.00,10.00,0.00,0.00,10.00,0.00],[SAMP006269,0.00,0.00,16.67,0.00,0.00,0.00,0.00,33.33,0.00,0.00,0.00,0.00,33.33,0.00,16.67,0.00,0.00,0.00,0.00,0.00],[SAMP006270,0.00,0.00,0.00,0.00,0.00,0.00,0.00,42.86,0.00,0.00,0.00,0.00,42.86,0.00,0.00,0.00,0.00,0.00,14.29,0.00],[SAMP006271,0.00,0.00,0.00,0.00,9.09,9.09,0.00,9.09,0.00,0.00,9.09,0.00,9.09,9.09,0.00,9.09,0.00,0.00,18.18,18.18],[SAMP006272,0.00,0.00,9.09,0.00,9.09,0.00,9.09,18.18,0.00,0.00,9.09,0.00,18.18,0.00,18.18,9.09,0.00,0.00,0.00,0.00],[SAMP006273,0.00,0.00,0.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00],[SAMP006274,0.00,0.00,0.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,50.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00]]}","NumSamples":54,"NumSpec":105,"Observations":696,"Abundance":2419,"Period":"Medieval","NISP":null},

# {"source":"Excavated Site DB","Identifier":null,"Start":900,"End":1000,"Phase":null,"placename":"Arnarvatn","regional catchment area":null,"function of site":null,"type of site":"Kuml ","Title":null,"Oldest extant manuscript shelf number":null,"Oldest extant manuscript date":null,"country":"Iceland","Lat":65.583099,"Lon":-17.1313,"size":null,"Who":null,"What":"Site Info","theme":null,"tags":"skeleton","# of Resources":null,"Link":null,"Description":null,"Data":null,"NumSamples":null,"NumSpec":null,"Observations":null,"Abundance":null,"Period":null,"NISP":null}

# {"source":"NABONE","Identifier":null,"Start":null,"End":1200,"Phase":null,"placename":"Greenland","regional catchment area":null,"function of site":null,"type of site":null,"Title":"E29N","Oldest extant manuscript shelf number":null,"Oldest extant manuscript date":null,"country":null,"Lat":61.092274,"Lon":-45.305727,"size":null,"Who":null,"What":null,"theme":null,"tags":null,"# of Resources":null,"Link":null,"Description":"McGovern Thomas H., Konrad Smiarowski, Albina Palsdóttir (2006) Preliminary Report of a Medieval Norse Archaeofauna from Brattahlið North Farm (KNK 2629), Qassiarsuk, Greenland. NABO NORSEC Lab report 34, available www.nabohome.org","Data":"{perc:[43.53,0.86,58.19,3.88,9.05,0.86,2.59,0,0],domPerc:[44.55,0,0.99,0.99,2.97,6.93,43.560]}","NumSamples":null,"NumSpec":null,"Observations":null,"Abundance":null,"Period":"EM","NISP":232}]



# require 'json/stream'
text = File.read('/Users/abrin/Dropbox (ASU)/dataarc.json')
# obj = JSON::Stream::Parser.parse(json)
require 'json'

puts '{
  "type": "FeatureCollection",
  "features": ['

json = JSON.parse(text)
first = true
json.each do |entry|
  tmp = JSON.parse('{"type":"Feature","geometry":{"type":"Point"},"properties":{}}')
  lat = nil
  lon = nil
  entry.each_pair do |k, v|
    # puts "#{k} --> #{v}"
    
    if (k == "Lat")
      lat = v
      next
    end
    if (k == "Lon")
      lon = v
      next
    end
    if (k == "Data" && v.kind_of?(String))
      # puts "||#{v}||"
      next if (v.nil? || v.to_s == '' || v.to_s.match(/(\-+)/))
      # puts v
      ## cleanup double-encoded, bad JSON 
      v_ = v.gsub(/(['"])?([a-zA-Z0-9_]+)(['"])?:/, '"\2":')
      v_ = v_.gsub(/(?:\[)[^\"]([a-zA-Z][a-zA-Z0-9_]+)/, '[["\1"')
      v_ = v_.gsub(/,\[\[/,",[")
      json_ = JSON.parse(v_)

      ## IF NABONE
      if (json_.kind_of?(Hash))
        if (json_.has_key?("perc") && json_.has_key?("domPerc"))
          ## cleanup nabone
          instruments = ["Dom %","Whale %","Seal %","Walrus %","Caribou %" , "Other mam %" ,"Bird %" , "Fish %", "Mol Arth Gast %"]
          members = json_['perc']
          perc = {}
          instruments.each_with_index do |item,i|
            perc[item] = members[i]
          end
          domPerc = {}
          members = json_['domPerc']
          instruments = ["Bos dom %", "Canis dom %", "Sus dom %",  "Equ dom %",  "Cap dom %",  "Ovi dom %", "Ovca dom %", "Felis dom %"]
          instruments.each_with_index do |item,i|
            domPerc[item] = members[i]
          end
          tmp["properties"]['perc'] = perc
          tmp["properties"]['domPerc'] = domPerc
        else 
          sites = [];
          json_.each_pair do |kk,vv|
            vv.each_with_index do |vvv,i|
              cleaned = {}
              members = vvv
              # puts "#{members}"
              instruments = ["Sample","Aquatics", "Carrion", "Disturbed/arable", "Dung/foul habitats", "Ectoparasite", "General synanthropic", "Halotolerant", "Heathland & moorland", "Indicators: Coniferous", "Indicators: Deciduous", "Indicators: Dung", "Indicators: Standing water", "Meadowland", "Mould beetles", "Open wet habitats", "Pasture/Dung", "Sandy/dry disturbed/arable", "Stored grain pest", "Wetlands/marshes", "Wood and trees"]
              instruments.each_with_index do |itm,j|
                members[j] = "S" + members[j] if (itm == "Sample" && members[j][0] == 'A')
                # puts members[j] if (itm == "Sample")
                cleaned[itm] = members[j]
              end
              cleaned['SiteCode'] = kk
              # puts cleaned
              vv[i] = cleaned
              sites.push(cleaned)
            end
          end
          tmp['properties']['Samples'] = sites
          # puts json_
          # IF SEAD
          # json_ = v.gsub(/\"AMP/,"\"SAMP")
#          tmp['properties']['samples'] = json_
        end

        
        # json_.each_pair do |kk, vv|
        #   data = {}
        #   tmp["properties"]['data'] = data
        #
        # end
      end
      next
    end
   tmp["properties"][k] = v
  end
  if (lat == "----------" || lat == "----")
    next
  end
  unless (lat.nil? && lon.nil?)
    tmp['geometry']['coordinates'] = [lon,lat]
  end
  unless first
    puts ","
  end
  first = false
  puts JSON.pretty_generate(tmp)
#    entry.do_something
end

puts ']}'

